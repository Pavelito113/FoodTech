@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è";
    var isAdmin = User.IsInRole("Admin");
    var isManager = User.IsInRole("Manager");
    var isUser = User.IsInRole("User");
}

<div class="container mt-4">
    <h4 class="mb-4 d-flex align-items-center gap-2">
        <i class="bi bi-speedometer2 text-primary"></i>
        –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    </h4>

    <ul class="nav nav-tabs" id="adminTabs">
        @if (isAdmin)
        {
            <li class="nav-item">
                <a class="nav-link active" data-tab="EditUsers">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="RequestManagement">–ó–∞–ø—Ä–æ—Å—ã</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="EditIndustries">–û—Ç—Ä–∞—Å–ª–∏</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="EditCategories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="EditManufacturer">–ó–∞–≤–æ–¥—ã</a>
            </li>
        }
        else if (isManager)
        {
            <li class="nav-item">
                <a class="nav-link active" data-tab="RequestManagement">–ó–∞–ø—Ä–æ—Å—ã</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="EditIndustries">–û—Ç—Ä–∞—Å–ª–∏</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="EditCategories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            </li>
        }
        else if (isUser)
        {
            <li class="nav-item">
                <a class="nav-link active" data-tab="MyRequests">–ú–æ–∏ –∑–∞–ø—Ä–æ—Å—ã</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="MyManufacturer">–ú–æ–π –∑–∞–≤–æ–¥</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="EditIndustries">–û—Ç—Ä–∞—Å–ª–∏</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="EditCategories">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a>
            </li>
        }
    </ul>

    <div id="tabContent" class="mt-3"></div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const tabs = document.querySelectorAll("#adminTabs .nav-link");
            const container = document.getElementById("tabContent");

            // –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–æ–ª–µ–π
            const routeMap = {
                // –û–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ä–æ–ª–µ–π
                "EditIndustries": "/admin/industries",
                "EditCategories": "/admin/categories",
                
                // –î–ª—è Admin/Manager
                "EditUsers": "/admin/users",
                "RequestManagement": "/admin/requests",
                "EditManufacturer": "/admin/manufacturers",
                
                // –î–ª—è User
                "MyRequests": "/admin/requests/my-requests",
                "MyManufacturer": "/my-manufacturer/edit"
            };

            const initMap = {
                "EditIndustries": window.initEditIndustries,
                "EditCategories": window.initEditCategories,
                "EditManufacturer": window.initEditManufacturer,
                "EditUsers": window.initEditUsers,
                "RequestManagement": window.initRequestManagement,
                "MyRequests": window.initMyRequests,
                "MyManufacturer": window.initMyManufacturer
            };

            async function loadTab(tabName) {
                console.log(`üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∫–ª–∞–¥–∫–∏: ${tabName}`);

                container.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div class="mt-2 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ ${tabName}...</div>
                    </div>`;

                try {
                    const url = routeMap[tabName];
                    if (!url) throw new Error(`–ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ '${tabName}' –Ω–µ –Ω–∞–π–¥–µ–Ω`);

                    const resp = await fetch(url, {
                        method: "GET",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "Accept": "text/html"
                        },
                        credentials: "include"
                    });

                    if (!resp.ok) {
                        if (resp.status === 403) {
                            throw new Error("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏.");
                        }
                        if (resp.status === 404) {
                            throw new Error("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏–ª–∏ –º–µ—Ç–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.");
                        }
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                    }

                    const html = await resp.text();
                    container.innerHTML = html;

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
                    tabs.forEach(t => t.classList.remove("active"));
                    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                    if (activeTab) {
                        activeTab.classList.add("active");
                    }

                    console.log(`‚úÖ –í–∫–ª–∞–¥–∫–∞ "${tabName}" –∑–∞–≥—Ä—É–∂–µ–Ω–∞`);

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ PartialManager –∏–ª–∏ –∞–≤–∞—Ä–∏–π–Ω–æ
                    if (window.PartialManager && typeof window.PartialManager.init === "function") {
                        window.PartialManager.init(tabName, container);
                    } else {
                        emergencyInit(tabName, container);
                    }

                } catch (err) {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª–∞–¥–∫–∏:", err);
                    container.innerHTML = `
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª–∞–¥–∫–∏:</strong> ${err.message}
                            <div class="mt-2">
                                <small>URL: ${routeMap[tabName] || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}</small>
                                <br>
                                <small>–†–æ–ª—å: @User.Identity?.Name</small>
                            </div>
                            <div class="mt-2">
                                <a href="javascript:location.reload()" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                </a>
                            </div>
                        </div>`;
                }
            }

            function emergencyInit(tabName, container) {
                console.log(`üö® –ê–≤–∞—Ä–∏–π–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ${tabName}`);
                const initFn = initMap[tabName];
                if (initFn && typeof initFn === "function") {
                    try {
                        initFn(container);
                        console.log(`‚úÖ –ê–≤–∞—Ä–∏–π–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ${tabName} —É—Å–ø–µ—à–Ω–∞`);
                    } catch (err) {
                        console.error(`‚ùå –û—à–∏–±–∫–∞ –∞–≤–∞—Ä–∏–π–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ${tabName}:`, err);
                    }
                } else {
                    console.warn(`‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è ${tabName} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            tabs.forEach(tab => {
                tab.addEventListener("click", e => {
                    e.preventDefault();
                    const tabName = tab.dataset.tab;
                    if (!tab.classList.contains("active")) {
                        loadTab(tabName);
                        localStorage.setItem("activeTab", tabName);
                    }
                });
            });

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏: —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const defaultTab = document.querySelector("#adminTabs .nav-link.active")?.dataset.tab;
            const firstTab = document.querySelector("#adminTabs .nav-link")?.dataset.tab;
            const activeTabName = localStorage.getItem("activeTab") || defaultTab || firstTab;

            if (activeTabName) {
                loadTab(activeTabName);
            }
        });
    </script>
}