@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model List<FoodTech.ViewModels.ManufacturerVm>

<div id="editManufacturersContainer" class="card shadow-sm border-0">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
    <div class="card-header bg-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center py-3 px-3 px-md-4">
        <div class="d-flex align-items-center gap-2 mb-2 mb-md-0">
            <i class="bi bi-building fs-5"></i>
            <div>
                <h1 class="h5 mb-0 fw-semibold">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏</h1>
                <small class="opacity-75 d-none d-md-inline">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è–º–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</small>
            </div>
        </div>

        <button id="addManufacturerBtn" 
                class="btn btn-light btn-sm px-3 py-2 w-100 w-md-auto"
                type="button"
                aria-label="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è">
            <i class="bi bi-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å
        </button>
    </div>

    <div class="card-body p-0">
        <!-- –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
        <div class="d-none d-lg-block">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" aria-label="–°–ø–∏—Å–æ–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="ps-4" style="min-width: 200px;">
                                <span class="fw-semibold">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
                            </th>
                            <th scope="col" class="text-center" style="min-width: 100px;">
                                <span class="fw-semibold">–°—Ç—Ä–∞–Ω–∞</span>
                            </th>
                            <th scope="col" style="min-width: 180px;">
                                <span class="fw-semibold">–°–∞–π—Ç</span>
                            </th>
                            <th scope="col" style="min-width: 160px;">
                                <span class="fw-semibold">–ö–æ–Ω—Ç–∞–∫—Ç</span>
                            </th>
                            <th scope="col" style="min-width: 140px;">
                                <span class="fw-semibold">–î–æ–±–∞–≤–ª–µ–Ω</span>
                            </th>
                            <th scope="col" style="min-width: 180px;">
                                <span class="fw-semibold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                            </th>
                            <th scope="col" style="width: 120px;" class="pe-4 text-end">
                                <span class="fw-semibold">–î–µ–π—Å—Ç–≤–∏—è</span>
                            </th>
                        </tr>
                    </thead>

                    <tbody>
                    @foreach (var m in Model)
                    {
                        <tr>
                            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                            <td class="ps-4 py-3">
                                <div class="d-flex flex-column">
                                    <strong class="text-truncate" style="max-width: 250px;" title="@m.Name">@m.Name</strong>
                                    @if (!string.IsNullOrWhiteSpace(m.Notes))
                                    {
                                        <small class="text-muted mt-1 text-truncate" style="max-width: 250px;">@m.Notes</small>
                                    }
                                </div>
                            </td>

                            <!-- –°—Ç—Ä–∞–Ω–∞ -->
                            <td class="text-center py-3">
                                @if (!string.IsNullOrWhiteSpace(m.Country))
                                {
                                    <span class="badge bg-secondary bg-opacity-10 text-dark px-2 py-1">
                                        @m.Country
                                    </span>
                                }
                            </td>

                            <!-- –°–∞–π—Ç -->
                            <td class="py-3">
                                @if (!string.IsNullOrWhiteSpace(m.Website))
                                {
                                    <a href="@(m.Website.StartsWith("http") ? m.Website : "https://" + m.Website)" 
                                       target="_blank" 
                                       rel="noopener noreferrer"
                                       class="text-decoration-none text-primary">
                                        <i class="bi bi-box-arrow-up-right me-1 small"></i>
                                        <span class="text-truncate d-inline-block" style="max-width: 180px;">@m.Website</span>
                                    </a>
                                }
                            </td>

                            <!-- –ö–æ–Ω—Ç–∞–∫—Ç -->
                            <td class="py-3">
                                <div class="d-flex flex-column gap-1">
                                    @if (!string.IsNullOrWhiteSpace(m.ContactPerson))
                                    {
                                        <div>@m.ContactPerson</div>
                                    }
                                    
                                    @if (!string.IsNullOrWhiteSpace(m.ContactPhone))
                                    {
                                        <a href="tel:@m.ContactPhone" 
                                           class="text-decoration-none text-dark">
                                            @m.ContactPhone
                                        </a>
                                    }
                                    
                                    @if (!string.IsNullOrWhiteSpace(m.ContactEmail))
                                    {
                                        <a href="mailto:@m.ContactEmail" 
                                           class="text-decoration-none text-dark text-truncate d-inline-block" 
                                           style="max-width: 180px;">
                                            @m.ContactEmail
                                        </a>
                                    }
                                </div>
                            </td>

                            <!-- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
                            <td class="py-3">
                                <div class="small text-muted">@m.CreatedAt.ToString("dd.MM.yyyy")</div>
                                <div class="fw-semibold small">@m.CreatedBy</div>
                            </td>

                            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
                            <td class="py-3">
                                @if (m.AssignedUsers?.Any() == true)
                                {
                                    <div class="d-flex flex-column gap-1">
                                        @foreach (var user in m.AssignedUsers.Take(2))
                                        {
                                            <div class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                                @user.FirstName @user.LastName
                                            </div>
                                        }
                                        @if (m.AssignedUsers.Count > 2)
                                        {
                                            <small class="text-muted">+ –µ—â–µ @(m.AssignedUsers.Count - 2)</small>
                                        }
                                    </div>
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
                                    <button class="btn btn-sm btn-outline-info mt-1 manage-users-btn"
                                            data-id="@m.ManufacturerId"
                                            data-name="@m.Name">
                                        <i class="bi bi-people"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted small">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                                    <button class="btn btn-sm btn-outline-info mt-1 manage-users-btn"
                                            data-id="@m.ManufacturerId"
                                            data-name="@m.Name">
                                        <i class="bi bi-person-plus"></i> –ü—Ä–∏–≤—è–∑–∞—Ç—å
                                    </button>
                                }
                            </td>

                            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                            <td class="pe-4 py-3 text-end">
                                <div class="d-flex justify-content-end gap-1">
                                    <button class="btn btn-outline-primary btn-sm edit-manufacturer-btn"
                                            data-id="@m.ManufacturerId"
                                            type="button"
                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i class="bi bi-pencil"></i>
                                    </button>

                                    <button class="btn btn-outline-danger btn-sm delete-manufacturer-btn"
                                            data-id="@m.ManufacturerId"
                                            data-name="@m.Name"
                                            type="button"
                                            title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö) -->
        <div class="d-lg-none">
            @if (Model.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var m in Model)
                    {
                        <div class="list-group-item border-0 p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h3 class="h6 mb-1 fw-semibold">@m.Name</h3>
                                    @if (!string.IsNullOrWhiteSpace(m.Country))
                                    {
                                        <span class="badge bg-secondary bg-opacity-10 text-dark">@m.Country</span>
                                    }
                                </div>
                                <div class="d-flex gap-1">
                                    <button class="btn btn-outline-primary btn-sm edit-manufacturer-btn"
                                            data-id="@m.ManufacturerId"
                                            type="button"
                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm delete-manufacturer-btn"
                                            data-id="@m.ManufacturerId"
                                            data-name="@m.Name"
                                            type="button"
                                            title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>

                            @if (!string.IsNullOrWhiteSpace(m.Notes))
                            {
                                <p class="small text-muted mb-2">@m.Notes</p>
                            }

                            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <h6 class="mb-0 fw-semibold">
                                        <i class="bi bi-people"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                                    </h6>
                                    <button class="btn btn-sm btn-outline-info manage-users-btn"
                                            data-id="@m.ManufacturerId"
                                            data-name="@m.Name">
                                        @if (m.AssignedUsers?.Any() == true)
                                        {
                                            <i class="bi bi-gear"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-person-plus"></i>
                                        }
                                    </button>
                                </div>
                                @if (m.AssignedUsers?.Any() == true)
                                {
                                    <div class="d-flex flex-wrap gap-1">
                                        @foreach (var user in m.AssignedUsers.Take(3))
                                        {
                                            <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                                @user.FirstName @user.LastName
                                            </span>
                                        }
                                        @if (m.AssignedUsers.Count > 3)
                                        {
                                            <small class="text-muted">+@(m.AssignedUsers.Count - 3)</small>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small">–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                                }
                            </div>

                            <div class="row g-2 small">
                                @if (!string.IsNullOrWhiteSpace(m.Website))
                                {
                                    <div class="col-12">
                                        <i class="bi bi-link-45deg me-1"></i>
                                        <a href="@(m.Website.StartsWith("http") ? m.Website : "https://" + m.Website)" 
                                           target="_blank" 
                                           rel="noopener noreferrer"
                                           class="text-decoration-none text-primary">
                                            @m.Website
                                        </a>
                                    </div>
                                }
                                
                                @if (!string.IsNullOrWhiteSpace(m.ContactPerson))
                                {
                                    <div class="col-12">
                                        <i class="bi bi-person me-1"></i>
                                        @m.ContactPerson
                                    </div>
                                }
                                
                                @if (!string.IsNullOrWhiteSpace(m.ContactPhone))
                                {
                                    <div class="col-12">
                                        <i class="bi bi-telephone me-1"></i>
                                        <a href="tel:@m.ContactPhone" class="text-decoration-none text-dark">
                                            @m.ContactPhone
                                        </a>
                                    </div>
                                }
                                
                                @if (!string.IsNullOrWhiteSpace(m.ContactEmail))
                                {
                                    <div class="col-12">
                                        <i class="bi bi-envelope me-1"></i>
                                        <a href="mailto:@m.ContactEmail" class="text-decoration-none text-dark">
                                            @m.ContactEmail
                                        </a>
                                    </div>
                                }
                            </div>

                            <div class="mt-3 pt-2 border-top small text-muted d-flex justify-content-between">
                                <span>–î–æ–±–∞–≤–ª–µ–Ω: @m.CreatedAt.ToString("dd.MM.yyyy")</span>
                                <span>@m.CreatedBy</span>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
                <div class="text-center py-5 px-3">
                    <div class="text-muted mb-3" style="font-size: 3rem;">
                        <i class="bi bi-building"></i>
                    </div>
                    <h3 class="h5 mb-2">–ù–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
                    <p class="text-muted small mb-4">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</p>
                    <button id="addManufacturerBtnEmptyMobile" 
                            class="btn btn-primary px-4"
                            type="button">
                        <i class="bi bi-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è
                    </button>
                </div>
            }
        </div>

        <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ -->
        @if (!Model.Any())
        {
            <div class="text-center py-5 px-3 d-none d-lg-block">
                <div class="text-muted mb-3" style="font-size: 3rem;">
                    <i class="bi bi-building"></i>
                </div>
                <h3 class="h5 mb-2">–ù–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π</h3>
                <p class="text-muted small mb-4">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</p>
                <button id="addManufacturerBtnEmpty" 
                        class="btn btn-primary px-4"
                        type="button">
                    <i class="bi bi-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è
                </button>
            </div>
        }
    </div>
    
    <!-- –§—É—Ç–µ—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
    @if (Model.Any())
    {
        <div class="card-footer bg-light py-2 px-3 border-top small">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                <span class="text-muted mb-1 mb-md-0">
                    <i class="bi bi-info-circle me-1"></i>
                    –ü–æ–∫–∞–∑–∞–Ω–æ: @Model.Count
                </span>
                <span class="text-muted">
                    –û–±–Ω–æ–≤–ª–µ–Ω–æ: @DateTime.Now.ToString("HH:mm")
                </span>
            </div>
        </div>
    }
</div>

<script>
    // –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    (function() {
        console.log('üìã –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π...');
        
        const container = document.getElementById('editManufacturersContainer');
        if (!container) {
            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä editManufacturersContainer –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º PartialManager –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –ø—Ä—è–º–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        if (typeof initEditManufacturer === 'function') {
            initEditManufacturer(container);
        } else {
            // –ê–≤–∞—Ä–∏–π–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            emergencyInit(container);
        }
        
        // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤
        function checkScreenSize() {
            const isMobile = window.innerWidth < 768;
            const interactiveElements = container.querySelectorAll('a[href^="tel:"], a[href^="mailto:"]');
            
            interactiveElements.forEach(el => {
                if (isMobile) {
                    el.style.padding = '4px 0';
                    el.style.display = 'inline-block';
                } else {
                    el.style.padding = '';
                }
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        window.addEventListener('load', checkScreenSize);
        window.addEventListener('resize', checkScreenSize);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ø—É—Å—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        document.addEventListener('click', function(e) {
            const emptyBtn = e.target.closest('#addManufacturerBtnEmpty, #addManufacturerBtnEmptyMobile');
            if (emptyBtn && typeof openManufacturerModal === 'function') {
                openManufacturerModal();
            }
        });
        
        // –ê–≤–∞—Ä–∏–π–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function emergencyInit(container) {
            console.log('üö® –ê–≤–∞—Ä–∏–π–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EditManufacturer');
            
            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
            const addBtn = container.querySelector('#addManufacturerBtn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    if (typeof openManufacturerModal === 'function') {
                        openManufacturerModal();
                    } else {
                        console.error('‚ùå –§—É–Ω–∫—Ü–∏—è openManufacturerModal –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    }
                });
            }
            
            // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            container.querySelectorAll('.edit-manufacturer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (typeof openManufacturerModal === 'function') {
                        openManufacturerModal(this.dataset.id);
                    }
                });
            });
            
            // –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            container.querySelectorAll('.delete-manufacturer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (typeof openDeleteModal === 'function') {
                        openDeleteModal(this.dataset.id, this.dataset.name);
                    }
                });
            });
            
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            container.querySelectorAll('.manage-users-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const manufacturerId = this.getAttribute('data-id');
                    if (typeof openUserAssignmentModal === 'function') {
                        await openUserAssignmentModal(manufacturerId);
                    } else {
                        console.error('‚ùå –§—É–Ω–∫—Ü–∏—è openUserAssignmentModal –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    }
                });
            });
        }
        
    })();
</script>