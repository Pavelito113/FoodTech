@using Microsoft.AspNetCore.Identity
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@model FoodTech.ViewModels.EquipmentIndexVm

@{
    ViewData["Title"] = "–ö–∞—Ç–∞–ª–æ–≥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è";
}
@{
    var pageSizes = new List<SelectListItem>
    {
        new SelectListItem { Value = "12", Text = "12", Selected = Model?.Filter?.PageSize == 12 },
        new SelectListItem { Value = "24", Text = "24", Selected = Model?.Filter?.PageSize == 24 },
        new SelectListItem { Value = "48", Text = "48", Selected = Model?.Filter?.PageSize == 48 },
    };
}


<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–ö–∞—Ç–∞–ª–æ–≥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>
    <div class="text-muted">
        –ù–∞–π–¥–µ–Ω–æ: @(Model.Pagination?.TotalItems ?? 0) —Ç–æ–≤–∞—Ä–æ–≤
    </div>
</div>

<div class="row g-4">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="col-lg-3 col-md-4">
        <div class="p-3 bg-white border rounded-4 shadow-sm position-relative">
            @await Html.PartialAsync("_FilterPartial", Model.Filter, new ViewDataDictionary(ViewData)
            {
                ["Industries"] = Model.Industries,
                ["Categories"] = Model.Categories,
                ["Manufacturers"] = Model.Manufacturers
            })
        </div>

        @if (Model.HotOffers?.Any() == true)
        {
            <div class="mt-4 bg-white border rounded-4 shadow-sm p-3">
                <h6 class="text-primary fw-semibold mb-3 d-flex align-items-center">
                    <i class="bi bi-fire text-danger me-2"></i> –ì–æ—Ä—è—á–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                </h6>

                <div class="list-group list-group-flush small">
                    @foreach (var offer in Model.HotOffers)
                    {
                        var url = Url.Action("Details", "Equipment", new { id = offer.EquipmentId });

                        <a href="@url"
                           class="list-group-item list-group-item-action border-0 rounded px-2 py-2 mb-1 bg-light-subtle hover-bg-light d-flex flex-column"
                           style="transition: background-color 0.2s ease;">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-semibold text-dark text-truncate" title="@offer.Name">@offer.Name</span>
                                @if (!string.IsNullOrEmpty(offer.Model))
                                {
                                    <small class="text-muted ms-2">@offer.Model</small>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(offer.ShortDescription))
                            {
                                <small class="text-muted mt-1 text-truncate">
                                    @(offer.ShortDescription.Length > 60 
                                        ? offer.ShortDescription.Substring(0, 60) + "..." 
                                        : offer.ShortDescription)
                                </small>
                            }
                        </a>
                    }
                </div>
            </div>
        }
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="col-lg-9 col-md-8">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º –≤–∏–¥–∞ -->
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3 py-2 px-3 bg-white border rounded-4 shadow-sm">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ -->
            <div class="text-muted small fw-medium">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ <span class="text-dark">@(Model.Pagination?.CurrentPage ?? 1)</span> 
                –∏–∑ <span class="text-dark">@(Model.Pagination?.TotalPages ?? 1)</span>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <!-- –ö–æ–ª-–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">–≠–ª–µ–º–µ–Ω—Ç–æ–≤:</span>
                    <select asp-for="Filter.PageSize"
        asp-items="pageSizes"
        class="form-select form-select-sm border-0 shadow-sm bg-light rounded-3"
        style="width: 80px;"
        onchange="location.href='@Url.Action("Index", new { pageSize = "__ps__" })'.replace('__ps__', this.value)">
</select>

                </div>

                <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∞ -->
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="view-mode" id="card-view" autocomplete="off" checked>
                    <label class="btn btn-outline-primary px-2 py-1" for="card-view" title="–í–∏–¥ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏">
                        <i class="bi bi-grid"></i>
                    </label>

                    <input type="radio" class="btn-check" name="view-mode" id="list-view" autocomplete="off">
                    <label class="btn btn-outline-primary px-2 py-1" for="list-view" title="–í–∏–¥ —Å–ø–∏—Å–∫–æ–º">
                        <i class="bi bi-list-task"></i>
                    </label>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç: –∫–∞—Ä—Ç–æ—á–∫–∏/—Å–ø–∏—Å–æ–∫ -->
        @await Html.PartialAsync("_EquipmentGridPartial", Model.Items ?? new List<FoodTech.ViewModels.EquipmentListItemVm>())

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        @if ((Model.Pagination?.TotalPages ?? 1) > 1)
        {
            <div class="mt-4">
                @await Html.PartialAsync("_PaginationPartial", Model.Pagination)
            </div>
        }
    </div>
</div>
@section Scripts {
<script>
document.addEventListener("DOMContentLoaded", () => {

    const tabs = document.querySelectorAll("#adminTabs .nav-link");
    const container = document.getElementById("tabContent");

    // üî• –ï–¥–∏–Ω–∞—è –∫–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
    const routeMap = {
        EditUsers: "/admin/users",
        EditRequests: "/admin/requests",
        EditIndustries: "/admin/industries",
        EditCategories: "/admin/categories",
        EditManufacturer: "/admin/manufacturers"
    };

    // ====================================================================
    // üìÇ –ó–ê–ì–†–£–ó–ö–ê –í–ö–õ–ê–î–ö–ò
    // ====================================================================
    async function loadTab(tabName) {

        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
                <div class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ ${tabName}...</div>
            </div>`;

        try {
            const url = routeMap[tabName];
            if (!url) throw new Error("–ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω");

            const resp = await fetch(url, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

            const html = await resp.text();
            container.innerHTML = html;

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            tabs.forEach(t => t.classList.remove("active"));
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add("active");

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è partial
            PartialManager.init(tabName, container);

        } catch (err) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª–∞–¥–∫–∏:", err);

            container.innerHTML = `
                <div class="alert alert-danger">
                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª–∞–¥–∫–∏ "${tabName}"
                </div>`;
        }
    }

    // ====================================================================
    // üü¶ –ö–õ–ò–ö–ò –ü–û –í–ö–õ–ê–î–ö–ê–ú
    // ====================================================================
    tabs.forEach(tab => {
        tab.addEventListener("click", e => {
            e.preventDefault();

            const tabName = tab.dataset.tab;
            if (!tabName) return;

            if (!tab.classList.contains("active")) {
                loadTab(tabName);
                localStorage.setItem("activeTab", tabName);
            }
        });
    });

    // ====================================================================
    // üöÄ –°–¢–ê–†–¢–û–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê
    // ====================================================================
    const saved = localStorage.getItem("activeTab");
    const firstTab = document.querySelector("#adminTabs .nav-link")?.dataset.tab;

    const initialTab = saved || firstTab;
    if (initialTab) loadTab(initialTab);
});
</script>
}
