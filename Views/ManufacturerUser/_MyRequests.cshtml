using FoodTech.ViewModels;
@model IEnumerable<ContactRequestUserVm>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Запросы на моё оборудование</h5>
    </div>
    <div class="card-body">
        @if (!Model.Any())
        {
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i> У вас пока нет запросов на оборудование
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Оборудование</th>
                            <th>Контакт</th>
                            <th>Сообщение</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            var request = item.ContactRequest;
                            <tr>
                                <td nowrap>@request.CreatedAt.ToString("dd.MM.yy HH:mm")</td>
                                <td>
                                    <strong>@(request.EquipmentName ?? "Без названия")</strong>
                                    <div class="small text-muted">
                                        @if (item.IsMyEquipment)
                                        {
                                            <span class="badge bg-success">Моё оборудование</span>
                                        }
                                        @if (item.IsMyManufacturer)
                                        {
                                            <span class="badge bg-info">Мой завод</span>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <strong>@request.Name</strong><br>
                                    @if (!string.IsNullOrEmpty(request.Company))
                                    {
                                        <small>@request.Company</small><br>
                                    }
                                    @if (!string.IsNullOrEmpty(request.Email))
                                    {
                                        <small class="text-muted">@request.Email</small><br>
                                    }
                                    @if (!string.IsNullOrEmpty(request.Phone))
                                    {
                                        <small class="text-muted">@request.Phone</small>
                                    }
                                </td>
                                <td>
                                    <div class="small text-truncate" style="max-width: 200px;" 
                                         title="@request.Message">
                                        @(request.Message ?? "Без сообщения")
                                    </div>
                                </td>
                                <td>
                                    @{
                                        var statusClass = request.Status == "Новый" ? "warning" : 
                                                         request.Status == "Обработан" ? "success" : 
                                                         request.Status == "Отклонен" ? "danger" : "secondary";
                                    }
                                    <span class="badge bg-@statusClass">
                                        @request.Status
                                    </span>
                                </td>
                                <td nowrap>
                                    @if (request.ContactRequestId.HasValue)
                                    {
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="showRequestDetails(@request.ContactRequestId)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    }
                                    @if (!string.IsNullOrEmpty(request.Email))
                                    {
                                        var equipmentName = string.IsNullOrEmpty(request.EquipmentName) ? 
                                                          "оборудование" : request.EquipmentName;
                                        var subject = $"Ответ на запрос: {equipmentName}";
                                        
                                        <a href="mailto:@request.Email?subject=@Uri.EscapeDataString(subject)" 
                                           class="btn btn-sm btn-outline-primary ms-1"
                                           title="Ответить по email">
                                            <i class="bi bi-reply"></i>
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<script>
function showRequestDetails(id) {
    fetch(`/admin/requests/details/${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Ошибка загрузки деталей запроса');
            }
            return response.text();
        })
        .then(html => {
            // Создаем модальное окно для отображения деталей
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = `
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Детали запроса</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${html}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            document.body.appendChild(modalDiv);
            const modalElement = modalDiv.querySelector('.modal');
            const modal = new bootstrap.Modal(modalElement);
            
            // Удаляем модальное окно после скрытия
            modalElement.addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modalDiv);
            });
            
            modal.show();
        })
        .catch(error => {
            alert('Не удалось загрузить детали запроса: ' + error.message);
        });
}
</script>